<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Driver Live Location with Audio & Directions</title>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; background:#f0f0f0; max-width:500px; margin:auto }
    .card { background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:16px }
    #map { height:300px; border-radius:8px; margin-bottom:12px }
    input, select, button { width:100%; margin-top:10px; padding:10px; border:1px solid #ccc; border-radius:6px }
    button { background:#007bff; color:#fff; border:none; cursor:pointer }
    button:hover { background:#0056b3 }
    .message { margin-top:10px }
    .error { color:red }
    .success { color:green }
    .btn-group { display:flex; flex-direction:column; gap:8px; margin-top:10px }
    .btn-row { display:flex; gap:8px }
    .btn-row button { flex:1 }
    @media (max-width: 400px) {
      .btn-row { flex-direction:column }
      .btn-row button { width:100% }
    }
  </style>
</head>
<body>

<h2>Driver Live Location</h2>

<div class="card">
  <label for="vehicle">Select Vehicle</label>
  <select id="vehicle">
    <option value="">-- Select --</option>
    <option value="BAH1996">BAH1996Â â€“Â Camry</option>
    <option value="XYZ7890">XYZ7890Â â€“Â Accord</option>
  </select>
  <div><b>Type:</b> <span id="vtype">-</span></div>
  <div><b>Color:</b> <span id="vcolor">-</span></div>
  <div><b>Phone:</b> <span id="vphone">-</span></div>
</div>

<div class="card">
  <div id="map">Loading mapâ€¦</div>
  
  <div class="btn-group">
    <div class="btn-row">
      <button id="startTracking">Start Tracking</button>
      <button id="stopTracking" disabled>Stop Tracking</button>
    </div>
    <div class="btn-row">
      <button id="currentLocationBtn">Get My Location</button>
      <button id="audioGuideBtn">Toggle Audio Guide</button>
    </div>
    <div class="btn-row">
      <button id="calculateBtn">Get Directions</button>
      <button id="resetBtn">Clear All</button>
    </div>
  </div>
  
  <div id="accuracyMsg" class="message"></div>

  <input id="locationInput" placeholder="ðŸ“Â Current Location (auto/manual)">
  <input id="coordsInput" placeholder="ðŸ“Â Coordinates" readonly>

  <hr>

  <input id="destinationInput" placeholder="ðŸ“Â Destination (autocomplete or manual)">
  <input id="destCoordsInput" placeholder="ðŸ“Â Destination Coordinates">

  <div id="routeInfo" class="message"></div>
</div>

<form id="locationForm" class="card">
  <input type="hidden" name="Vehicle_Registration"   id="reg">
  <input type="hidden" name="Vehicle_Type"           id="type">
  <input type="hidden" name="Vehicle_Color"          id="color">
  <input type="hidden" name="Driver_Phone"           id="phone">
  <input type="hidden" name="Location"               id="location">
  <input type="hidden" name="Coordinates"            id="coords">
  <input type="hidden" name="Destination"            id="destination">
  <input type="hidden" name="Destination_Coordinates" id="destCoords">
  <button type="submit">Send Location Data</button>
  <div id="submitMsg" class="message"></div>
</form>

<script>
  const el = id => document.getElementById(id);
  let map, marker, watchId, geocoder, directionsService, directionsRenderer;
  let speechOn = false;

  function speak(txt) {
    if (!speechOn) return;
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = 'en-US';
    speechSynthesis.speak(u);
  }

  const vehicleDB = {
    "BAH1996": { type:"Toyota Camry", color:"White", phone:"+260777123456" },
    "XYZ7890": { type:"Honda Accord", color:"Black", phone:"+260777987654" }
  };

  function initMap() {
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    map = new google.maps.Map(el("map"), { center:{lat:-15.4167,lng:28.2833}, zoom:15 });
    directionsRenderer = new google.maps.DirectionsRenderer({ map });
    marker = new google.maps.Marker({ map });

    const acPick = new google.maps.places.Autocomplete(el("locationInput"));
    acPick.setFields(["geometry","formatted_address"]);
    acPick.addListener("place_changed",()=>{
      const p=acPick.getPlace(); if(p.geometry) updatePosition(p.geometry.location.lat(), p.geometry.location.lng());
    });

    const acDest = new google.maps.places.Autocomplete(el("destinationInput"));
    acDest.setFields(["geometry","name"]);
    acDest.addListener("place_changed",()=>{
      const p=acDest.getPlace();
      if(p.geometry){
        const lat=p.geometry.location.lat(), lng=p.geometry.location.lng();
        el("destCoordsInput").value=`${lat.toFixed(6)},${lng.toFixed(6)}`;
        el("destCoords").value=el("destCoordsInput").value;
        el("destination").value=p.name;
        speak(`Destination ${p.name} set`);
      }
    });

    el("destCoordsInput").addEventListener("blur",()=>{
      const v=el("destCoordsInput").value.trim();
      const m=v.match(/^(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)$/);
      if(m){ const lat=parseFloat(m[1]), lng=parseFloat(m[2]);
        geocoder.geocode({location:{lat,lng}},(rs,st)=>{ if(st==="OK"&&rs[0]){
          el("destinationInput").value=rs[0].formatted_address;
          el("destination").value=rs[0].formatted_address;
          el("destCoords").value=v;
          speak(`Destination set to ${rs[0].formatted_address}`);
        }});
      }
    });

    el("vehicle").addEventListener("change",()=>{
      const v=vehicleDB[el("vehicle").value]||{};
      el("vtype").textContent=v.type||"-";
      el("vcolor").textContent=v.color||"-";
      el("vphone").textContent=v.phone||"-";
      el("reg").value=el("vehicle").value;
      el("type").value=v.type||"";
      el("color").value=v.color||"";
      el("phone").value=v.phone||"";
    });

    el("startTracking").addEventListener("click",startTracking);
    el("stopTracking").addEventListener("click",stopTracking);
    el("currentLocationBtn").addEventListener("click",getCurrentLocation);
    el("calculateBtn").addEventListener("click",calculateRoute);
    el("resetBtn").addEventListener("click",()=>{
      ["locationInput","coordsInput","destinationInput","destCoordsInput"].forEach(id=>el(id).value="");
      el("routeInfo").textContent="";
    });
    el("audioGuideBtn").addEventListener("click",()=>{
      speechOn=!speechOn;
      el("audioGuideBtn").textContent=speechOn?"Disable Audio":"Enable Audio";
      speak(speechOn?"Audio guide on":"Audio guide off");
    });

    el("locationForm").addEventListener("submit",e=>{
      e.preventDefault(); speak("Sending location"); setTimeout(()=>el("submitMsg").textContent="âœ… Sent",500);
    });
  }

  function updatePosition(lat,lng,acc){
    const pos={lat,lng}; marker.setPosition(pos); map.setCenter(pos);
    const cs=`${lat.toFixed(6)},${lng.toFixed(6)}`;
    el("coordsInput").value=cs; el("coords").value=cs;
    if(acc) el("accuracyMsg").textContent=`Accuracy Â±${Math.round(acc)}m`;
    geocoder.geocode({location:pos},(rs,st)=>{ if(st==="OK"&&rs[0]){
      el("locationInput").value=rs[0].formatted_address;
      el("location").value=rs[0].formatted_address;
      speak(`Current location: ${rs[0].formatted_address}`);
    }});
  }

  function startTracking(){
    if(!navigator.geolocation){ alert("No geolocation"); return; }
    el("startTracking").disabled=true; el("stopTracking").disabled=false;
    speak("Live tracking started");
    watchId=navigator.geolocation.watchPosition(p=>{ updatePosition(p.coords.latitude,p.coords.longitude,p.coords.accuracy); },e=>console.error(e),{enableHighAccuracy:true});
  }
  function stopTracking(){
    navigator.geolocation.clearWatch(watchId);
    el("startTracking").disabled=false; el("stopTracking").disabled=true;
    speak("Live tracking stopped");
  }

  function getCurrentLocation(){
    if(!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(p=>{ updatePosition(p.coords.latitude,p.coords.longitude); speak("Current location acquired"); });
  }

  function calculateRoute(){
    const f=el("coordsInput").value,t=el("destCoordsInput").value;
    if(!f||!t){ speak("Set both start and destination"); return; }
    const [fl,fg]=f.split(",").map(Number),[tl,tg]=t.split(",").map(Number);
    directionsService.route({ origin:{lat:fl,lng:fg}, destination:{lat:tl,lng:tg}, travelMode:"DRIVING" },(res,st)=>{
      if(st==="OK"){
        directionsRenderer.setDirections(res);
        const leg=res.routes[0].legs[0];
        el("routeInfo").innerHTML=`<span class='success'>Distance: ${leg.distance.text}, Time: ${leg.duration.text}</span>`;
        speak(`Distance ${leg.distance.text}, time ${leg.duration.text}`);
        leg.steps.forEach((stp,i)=> setTimeout(()=> speak(stp.instructions.replace(/<[^>]+>/g,"")),1500*i));
      } else {
        el("routeInfo").innerHTML=`<span class='error'>Route failed</span>`; speak("Route failed");
      }
    });
  }

  window.initMap=initMap;
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRdnvGw7epuDJjgBnpv0-FEuSQ6J-fyNY&libraries=places&callback=initMap" async defer></script>
</body>
  </html>
