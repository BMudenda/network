<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Driver Live Location with Enhanced Autocomplete</title>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; background:#f0f0f0; max-width:500px; margin:auto }
    .card { background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:16px }
    #map { height:300px; border-radius:8px; margin-bottom:12px }
    input, select, button { width:100%; margin-top:10px; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box }
    button { background:#007bff; color:#fff; border:none; cursor:pointer }
    button:hover { background:#0056b3 }
    .message { margin-top:10px }
    .error { color:red }
    .success { color:green }
    .btn-group { display:flex; flex-direction:column; gap:8px; margin-top:10px }
    .btn-row { display:flex; gap:8px }
    .btn-row button { flex:1; position:relative }
    .pac-container { z-index: 10000 !important; }
    .input-group { margin-bottom:16px; }
    .input-group h3 { margin:0 0 8px 0; font-size:16px; color:#333; }
    .input-row { display:flex; gap:8px; }
    .input-row input { flex:1; min-width:0; }
    .loader { 
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .status-icon {
      margin-left: 8px;
      vertical-align: middle;
    }
    .button-text { pointer-events: none; }
    @media (max-width: 400px) {
      .btn-row { flex-direction:column }
      .btn-row button { width:100% }
      .input-row { flex-direction:column; gap:10px; }
    }
  </style>
</head>
<body>

<h2>Driver Live Location</h2>

<div class="card">
  <label for="vehicle">Select Vehicle</label>
  <select id="vehicle">
    <option value="">-- Select --</option>
    <option value="BAH1996">BAH1996 – Camry</option>
    <option value="XYZ7890">XYZ7890 – Accord</option>
  </select>
  <div><b>Type:</b> <span id="vtype">-</span></div>
  <div><b>Color:</b> <span id="vcolor">-</span></div>
  <div><b>Phone:</b> <span id="vphone">-</span></div>
</div>

<div class="card">
  <div id="map">Loading map…</div>
  
  <div class="btn-group">
    <div class="btn-row">
      <button id="startTracking">Start Tracking</button>
      <button id="stopTracking" disabled>Stop Tracking</button>
    </div>
    <div class="btn-row">
      <button id="currentLocationBtn"><span class="button-text">Get My Location</span></button>
      <button id="audioGuideBtn">Toggle Audio Guide</button>
    </div>
    <div class="btn-row">
      <button id="calculateBtn"><span class="button-text">Get Directions</span></button>
      <button id="resetBtn">Clear All</button>
    </div>
  </div>
  
  <div id="accuracyMsg" class="message"></div>

  <div class="input-group">
    <h3>Current Location</h3>
    <div class="input-row">
      <input id="locationInput" placeholder="📍 Type address">
      <input id="coordsInput" placeholder="📍 Coordinates" readonly>
    </div>
  </div>

  <div class="input-group">
    <h3>Destination</h3>
    <div class="input-row">
      <input id="destinationInput" placeholder="📍 Type address">
      <input id="destCoordsInput" placeholder="📍 Coordinates">
    </div>
  </div>

  <div id="routeInfo" class="message"></div>
</div>

<form id="locationForm" class="card">
  <input type="hidden" name="Vehicle_Registration"   id="reg">
  <input type="hidden" name="Vehicle_Type"           id="type">
  <input type="hidden" name="Vehicle_Color"          id="color">
  <input type="hidden" name="Driver_Phone"           id="phone">
  <input type="hidden" name="Location"               id="location">
  <input type="hidden" name="Coordinates"            id="coords">
  <input type="hidden" name="Destination"            id="destination">
  <input type="hidden" name="Destination_Coordinates" id="destCoords">
  <button type="submit">Send Location Data</button>
  <div id="submitMsg" class="message"></div>
</form>

<script>
  const el = id => document.getElementById(id);
  let map, marker, watchId, geocoder, directionsService, directionsRenderer;
  let speechOn = false;
  let currentLocationAutocomplete, destinationAutocomplete;

  function showButtonStatus(buttonId, type, text) {
    const button = el(buttonId);
    const buttonText = button.querySelector('.button-text');
    
    // Clear any existing status
    button.querySelector('.loader')?.remove();
    button.querySelector('.status-icon')?.remove();
    
    if (type === 'loading') {
      const loader = document.createElement('span');
      loader.className = 'loader';
      button.appendChild(loader);
      button.disabled = true;
    } 
    else if (type === 'success') {
      const icon = document.createElement('span');
      icon.className = 'status-icon';
      icon.innerHTML = '✅';
      button.appendChild(icon);
      setTimeout(() => icon.remove(), 2000);
      button.disabled = false;
    }
    else if (type === 'error') {
      const icon = document.createElement('span');
      icon.className = 'status-icon';
      icon.innerHTML = '❌';
      button.appendChild(icon);
      setTimeout(() => icon.remove(), 2000);
      button.disabled = false;
    }
    
    if (text) {
      if (buttonId === 'currentLocationBtn') {
        el("accuracyMsg").textContent = text;
      } else if (buttonId === 'calculateBtn') {
        el("routeInfo").textContent = text;
      }
    }
  }

  function speak(txt) {
    if (!speechOn) return;
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = 'en-US';
    speechSynthesis.speak(u);
  }

  const vehicleDB = {
    "BAH1996": { type:"Toyota Camry", color:"White", phone:"+260777123456" },
    "XYZ7890": { type:"Honda Accord", color:"Black", phone:"+260777987654" }
  };

  function initMap() {
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    map = new google.maps.Map(el("map"), { 
      center: {lat: -15.4167, lng: 28.2833}, 
      zoom: 15,
      mapTypeControl: false,
      streetViewControl: false
    });
    directionsRenderer = new google.maps.DirectionsRenderer({ map });
    marker = new google.maps.Marker({ map });

    // Enhanced Current Location Autocomplete
    currentLocationAutocomplete = new google.maps.places.Autocomplete(
      el("locationInput"),
      {
        types: ['geocode'],
        componentRestrictions: {country: 'zm'},
        fields: ['geometry', 'formatted_address', 'name']
      }
    );
    currentLocationAutocomplete.addListener('place_changed', () => {
      const place = currentLocationAutocomplete.getPlace();
      if (!place.geometry) {
        el("locationInput").placeholder = "Enter a place";
        return;
      }
      updatePosition(place.geometry.location.lat(), place.geometry.location.lng());
    });

    // Enhanced Destination Autocomplete
    destinationAutocomplete = new google.maps.places.Autocomplete(
      el("destinationInput"),
      {
        types: ['geocode', 'establishment'],
        componentRestrictions: {country: 'zm'},
        fields: ['geometry', 'formatted_address', 'name']
      }
    );
    destinationAutocomplete.addListener('place_changed', () => {
      const place = destinationAutocomplete.getPlace();
      if (!place.geometry) {
        el("destinationInput").placeholder = "Enter a destination";
        return;
      }
      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();
      el("destCoordsInput").value = `${lat.toFixed(6)},${lng.toFixed(6)}`;
      el("destCoords").value = el("destCoordsInput").value;
      el("destination").value = place.name || place.formatted_address;
      speak(`Destination set to ${place.name || place.formatted_address}`);
      
      // Zoom to show both locations if current location is set
      if (el("coordsInput").value) {
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(place.geometry.location);
        bounds.extend(marker.getPosition());
        map.fitBounds(bounds);
      }
    });

    // Handle manual coordinate entry for destination
    el("destCoordsInput").addEventListener("blur", () => {
      const v = el("destCoordsInput").value.trim();
      const m = v.match(/^(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)$/);
      if (m) { 
        const lat = parseFloat(m[1]), lng = parseFloat(m[2]);
        geocoder.geocode({location: {lat, lng}}, (rs, st) => { 
          if (st === "OK" && rs[0]) {
            el("destinationInput").value = rs[0].formatted_address;
            el("destination").value = rs[0].formatted_address;
            el("destCoords").value = v;
            speak(`Destination set to ${rs[0].formatted_address}`);
          }
        });
      }
    });

    el("vehicle").addEventListener("change", () => {
      const v = vehicleDB[el("vehicle").value] || {};
      el("vtype").textContent = v.type || "-";
      el("vcolor").textContent = v.color || "-";
      el("vphone").textContent = v.phone || "-";
      el("reg").value = el("vehicle").value;
      el("type").value = v.type || "";
      el("color").value = v.color || "";
      el("phone").value = v.phone || "";
    });

    el("startTracking").addEventListener("click", startTracking);
    el("stopTracking").addEventListener("click", stopTracking);
    el("currentLocationBtn").addEventListener("click", getCurrentLocation);
    el("calculateBtn").addEventListener("click", calculateRoute);
    el("resetBtn").addEventListener("click", () => {
      ["locationInput", "coordsInput", "destinationInput", "destCoordsInput"].forEach(id => el(id).value = "");
      el("routeInfo").textContent = "";
      marker.setMap(null);
      directionsRenderer.setMap(null);
    });
    el("audioGuideBtn").addEventListener("click", () => {
      speechOn = !speechOn;
      el("audioGuideBtn").textContent = speechOn ? "Disable Audio" : "Enable Audio";
      speak(speechOn ? "Audio guide on" : "Audio guide off");
    });

    el("locationForm").addEventListener("submit", e => {
      e.preventDefault(); 
      speak("Sending location"); 
      setTimeout(() => el("submitMsg").textContent = "✅ Sent", 500);
    });
  }

  function updatePosition(lat, lng, acc) {
    const pos = {lat, lng}; 
    if (!marker.getMap()) marker.setMap(map);
    marker.setPosition(pos); 
    map.setCenter(pos);
    const cs = `${lat.toFixed(6)},${lng.toFixed(6)}`;
    el("coordsInput").value = cs; 
    el("coords").value = cs;
    if (acc) el("accuracyMsg").textContent = `Accuracy ±${Math.round(acc)}m`;
    geocoder.geocode({location: pos}, (rs, st) => { 
      if (st === "OK" && rs[0]) {
        el("locationInput").value = rs[0].formatted_address;
        el("location").value = rs[0].formatted_address;
        speak(`Current location: ${rs[0].formatted_address}`);
      }
    });
  }

  function startTracking() {
    if (!navigator.geolocation) { alert("Geolocation is not supported by your browser"); return; }
    el("startTracking").disabled = true; 
    el("stopTracking").disabled = false;
    speak("Live tracking started");
    watchId = navigator.geolocation.watchPosition(
      p => { updatePosition(p.coords.latitude, p.coords.longitude, p.coords.accuracy); },
      e => { 
        console.error(e); 
        speak("Location error occurred");
        el("accuracyMsg").textContent = "Error getting location";
      },
      {enableHighAccuracy: true, maximumAge: 10000, timeout: 5000}
    );
  }

  function stopTracking() {
    navigator.geolocation.clearWatch(watchId);
    el("startTracking").disabled = false; 
    el("stopTracking").disabled = true;
    speak("Live tracking stopped");
  }

  function getCurrentLocation() {
    if (!navigator.geolocation) {
      showButtonStatus('currentLocationBtn', 'error', "Geolocation not supported");
      speak("Geolocation not supported");
      return;
    }
    
    showButtonStatus('currentLocationBtn', 'loading', "Getting your location...");
    speak("Getting your location");
    
    navigator.geolocation.getCurrentPosition(
      p => { 
        updatePosition(p.coords.latitude, p.coords.longitude); 
        showButtonStatus('currentLocationBtn', 'success', `Location acquired (Accuracy: ±${Math.round(p.coords.accuracy)}m)`);
        speak("Current location acquired");
      },
      e => {
        console.error(e);
        let errorMessage = "Could not get your location";
        switch(e.code) {
          case e.PERMISSION_DENIED:
            errorMessage = "Location permission denied";
            break;
          case e.POSITION_UNAVAILABLE:
            errorMessage = "Location information unavailable";
            break;
          case e.TIMEOUT:
            errorMessage = "Location request timed out";
            break;
        }
        showButtonStatus('currentLocationBtn', 'error', errorMessage);
        speak(errorMessage);
      },
      {enableHighAccuracy: true, timeout: 10000}
    );
  }

  function calculateRoute() {
    const from = el("coordsInput").value;
    const to = el("destCoordsInput").value;
    
    if (!from || !to) { 
      showButtonStatus('calculateBtn', 'error', "Please set both current location and destination");
      speak("Please set both current location and destination"); 
      return; 
    }
    
    showButtonStatus('calculateBtn', 'loading', "Calculating route...");
    speak("Calculating route");
    
    const [fromLat, fromLng] = from.split(",").map(Number);
    const [toLat, toLng] = to.split(",").map(Number);
    
    directionsService.route({
      origin: {lat: fromLat, lng: fromLng},
      destination: {lat: toLat, lng: toLng},
      travelMode: "DRIVING",
      provideRouteAlternatives: false
    }, (res, st) => {
      if (st === "OK") {
        directionsRenderer.setDirections(res);
        const leg = res.routes[0].legs[0];
        const successMessage = `Distance: ${leg.distance.text}, Time: ${leg.duration.text}`;
        showButtonStatus('calculateBtn', 'success', successMessage);
        el("routeInfo").innerHTML = `<span class='success'>${successMessage}</span>`;
        speak(`Route found. ${successMessage}`);
        
        // Speak directions with delays
        let delay = 0;
        leg.steps.forEach((step, i) => {
          setTimeout(() => {
            speak(step.instructions.replace(/<[^>]+>/g, ""));
          }, delay);
          delay += 2000; // 2 second delay between instructions
        });
      } else {
        const errorMessage = "Route calculation failed";
        showButtonStatus('calculateBtn', 'error', errorMessage);
        el("routeInfo").innerHTML = `<span class='error'>${errorMessage}</span>`;
        speak(errorMessage);
      }
    });
  }

  window.initMap = initMap;
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRdnvGw7epuDJjgBnpv0-FEuSQ6J-fyNY&libraries=places&callback=initMap" async defer></script>
</body>
</html>
