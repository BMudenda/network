<!DOCTYPE html>
<html>
<head>
  <title>Driver/Customer Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; padding: 10px; }
    .form-section { margin-bottom: 15px; }
    .form-section label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, select, button { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ccc; }
    .row { display: flex; gap: 10px; }
    .row > div { flex: 1; }
    #map { height: 300px; margin: 10px 0; display: none; }
    .trip-summary { display: flex; justify-content: space-between; gap: 10px; font-weight: bold; }
    .hidden { display: none; }
    .tracking-status { color: green; font-weight: bold; margin-bottom: 10px; }
  </style>
</head>
<body>

<h2>Track Your Ride</h2>

<div class="form-section">
  <label for="submitterType">Submitter Type</label>
  <select id="submitterType" onchange="toggleFields()">
    <option value="Customer">Customer</option>
    <option value="Driver">Driver</option>
  </select>
</div>

<div class="form-section">
  <label for="phone">Phone Number</label>
  <input type="tel" id="phone" placeholder="Enter phone number" required>
</div>

<div id="driverFields" class="hidden">
  <div class="form-section">
    <label for="vehicle">Vehicle</label>
    <select id="vehicle">
      <option value="BAH1996, ist, Silver">BAH1996, ist, Silver</option>
      <option value="BAH2345, Vitz, Blue">BAH2345, Vitz, Blue</option>
      <option value="BAH9876, Corolla, White">BAH9876, Corolla, White</option>
      <option value="BAH3456, Harrier, Black">BAH3456, Harrier, Black</option>
      <option value="BAH5678, Mazda, Red">BAH5678, Mazda, Red</option>
    </select>
  </div>
  <button onclick="startTracking()">Start Live Tracking</button>
  <button onclick="stopTracking()">Stop Live Tracking</button>
  <div id="trackingStatus" class="tracking-status hidden">Tracking...</div>
</div>

<div id="customerFields" class="form-section">
  <label for="startTime">Start Off Time</label>
  <input type="time" id="startTime">
</div>

<div class="form-section">
  <label for="origin">Current Location</label>
  <input id="origin" placeholder="Enter current place">
</div>

<div class="form-section">
  <label for="originCoords">Current Coordinates</label>
  <input id="originCoords" placeholder="Latitude, Longitude">
</div>

<div class="form-section">
  <label for="destination">Destination</label>
  <input id="destination" placeholder="Enter destination">
</div>

<div class="form-section">
  <label for="destinationCoords">Destination Coordinates</label>
  <input id="destinationCoords" placeholder="Latitude, Longitude">
</div>

<div class="trip-summary">
  <div id="distance">Distance: -</div>
  <div id="duration">Duration: -</div>
  <div id="cost">Cost: -</div>
</div>

<button onclick="calculateRoute()">Calculate Route</button>
<button onclick="submitData()">Submit</button>
<button onclick="toggleMap()">Show/Hide Map</button>

<div id="map"></div>

<script>
  let map, directionsService, directionsRenderer, watchID;

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 14,
      center: { lat: -13.1339, lng: 27.8493 },
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map });

    const originInput = document.getElementById("origin");
    const destInput = document.getElementById("destination");

    const autocomplete1 = new google.maps.places.Autocomplete(originInput);
    const autocomplete2 = new google.maps.places.Autocomplete(destInput);

    autocomplete1.addListener("place_changed", () => {
      const place = autocomplete1.getPlace();
      if (place.geometry) {
        const loc = place.geometry.location;
        document.getElementById("originCoords").value = `${loc.lat()},${loc.lng()}`;
      }
    });

    autocomplete2.addListener("place_changed", () => {
      const place = autocomplete2.getPlace();
      if (place.geometry) {
        const loc = place.geometry.location;
        document.getElementById("destinationCoords").value = `${loc.lat()},${loc.lng()}`;
      }
    });
  }

  function toggleFields() {
    const type = document.getElementById("submitterType").value;
    document.getElementById("driverFields").classList.toggle("hidden", type !== "Driver");
    document.getElementById("customerFields").classList.toggle("hidden", type !== "Customer");
  }

  function toggleMap() {
    const mapDiv = document.getElementById("map");
    mapDiv.style.display = mapDiv.style.display === "none" ? "block" : "none";
  }

  function startTracking() {
    if (navigator.geolocation) {
      watchID = navigator.geolocation.watchPosition(pos => {
        const coords = `${pos.coords.latitude},${pos.coords.longitude}`;
        document.getElementById("originCoords").value = coords;
        map.setCenter({ lat: pos.coords.latitude, lng: pos.coords.longitude });
      });
      document.getElementById("trackingStatus").classList.remove("hidden");
    } else {
      alert("Geolocation not supported");
    }
  }

  function stopTracking() {
    navigator.geolocation.clearWatch(watchID);
    document.getElementById("trackingStatus").classList.add("hidden");
  }

  function calculateRoute() {
    const [lat1, lng1] = document.getElementById("originCoords").value.split(",").map(Number);
    const [lat2, lng2] = document.getElementById("destinationCoords").value.split(",").map(Number);

    const origin = new google.maps.LatLng(lat1, lng1);
    const destination = new google.maps.LatLng(lat2, lng2);

    directionsService.route({
      origin,
      destination,
      travelMode: google.maps.TravelMode.DRIVING,
    }, (response, status) => {
      if (status === "OK") {
        directionsRenderer.setDirections(response);
        const leg = response.routes[0].legs[0];
        document.getElementById("distance").innerText = "Distance: " + leg.distance.text;
        document.getElementById("duration").innerText = "Duration: " + leg.duration.text;
        const cost = (leg.distance.value / 1000) * 10; // 10 ZMW per KM
        document.getElementById("cost").innerText = `Cost: ZMW ${cost.toFixed(2)}`;
      } else {
        alert("Route error: " + status);
      }
    });
  }

  function submitData() {
    const url = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // Replace with your real script URL

    const data = {
      submitterType: document.getElementById("submitterType").value,
      phone: document.getElementById("phone").value,
      vehicle: document.getElementById("vehicle")?.value || "",
      startTime: document.getElementById("startTime")?.value || "",
      currentLocation: document.getElementById("origin").value,
      currentCoords: document.getElementById("originCoords").value,
      destination: document.getElementById("destination").value,
      destinationCoords: document.getElementById("destinationCoords").value,
      distance: document.getElementById("distance").innerText.replace("Distance: ", ""),
      duration: document.getElementById("duration").innerText.replace("Duration: ", ""),
      cost: document.getElementById("cost").innerText.replace("Cost: ZMW ", ""),
      timestamp: new Date().toLocaleString()
    };

    fetch(url + "?" + new URLSearchParams(data), { method: "GET" })
      .then(res => res.ok ? alert("Submitted successfully!") : alert("Submission failed"))
      .catch(err => alert("Error: " + err));
  }
</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRdnvGw7epuDJjgBnpv0-FEuSQ6J-fyNY&libraries=places&callback=initMap">
</script>

</body>
</html>
