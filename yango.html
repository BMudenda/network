<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Luanshya Taxi Booking</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: red;
      margin: 0;
      padding: 0;
    }
    header {
      background: #8B0000;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .form-container {
      max-width: 500px;
      margin: 1rem auto;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      background: navy;
      color: white;
      border: none;
      cursor: pointer;
    }
    #map {
      height: 300px;
      width: 100%;
      margin-top: 10px;
      border-radius: 8px;
    }
    #message {
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <h1>Luanshya Taxi Booking</h1>
  </header>
  <div class="form-container">
    <input id="from" placeholder="Where from" />
    <input id="to" placeholder="Where to" />
    <input id="time" type="time" />
    <select id="luggage">
      <option value="no">Luggage? No</option>
      <option value="yes">Luggage? Yes</option>
    </select>
    <input id="phone" placeholder="Phone number" />
    <input id="distance" placeholder="Estimated Distance (km)" readonly />
    <input id="duration" placeholder="Estimated Time (min)" readonly />
    <input id="fare" placeholder="Estimated Cost (K)" readonly />
    
    <button onclick="calculateTrip()">Estimate Fare</button>
    <button onclick="confirmBooking()">Confirm Request</button>
    <button onclick="cancelBooking()">Cancel Request</button>
    <button onclick="sendBooking()">Send Request</button>

    <p id="message"></p>
    <div id="map"></div>
  </div>

  <script>
    let map, geocoder, distanceService, directionsService, directionsRenderer;
    let latestBooking = null;

    function initMap() {
      geocoder = new google.maps.Geocoder();
      distanceService = new google.maps.DistanceMatrixService();
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer();

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: { lat: -13.1339, lng: 28.4000 } // Luanshya
      });
      directionsRenderer.setMap(map);

      new google.maps.places.Autocomplete(document.getElementById("from"));
      new google.maps.places.Autocomplete(document.getElementById("to"));
    }

    function calculateTrip() {
      const origin = document.getElementById("from").value;
      const destination = document.getElementById("to").value;

      if (!origin || !destination) {
        alert("Please enter both origin and destination");
        return;
      }

      distanceService.getDistanceMatrix({
        origins: [origin],
        destinations: [destination],
        travelMode: 'DRIVING'
      }, (response, status) => {
        if (status === 'OK') {
          const result = response.rows[0].elements[0];
          const distanceKm = result.distance.value / 1000;
          const durationMin = result.duration.value / 60;
          const hasLuggage = document.getElementById("luggage").value === "yes";
          let baseCost = (distanceKm / 4) * 20;
          const luggageFee = hasLuggage ? 10 : 0;
          const totalCost = baseCost + luggageFee;

          document.getElementById("distance").value = distanceKm.toFixed(2) + " km";
          document.getElementById("duration").value = durationMin.toFixed(0) + " min";
          document.getElementById("fare").value = "K" + totalCost.toFixed(2);

          directionsService.route({
            origin,
            destination,
            travelMode: 'DRIVING'
          }, (result, status) => {
            if (status === 'OK') directionsRenderer.setDirections(result);
          });
        } else {
          alert("Failed to calculate route");
        }
      });
    }

    function confirmBooking() {
      const phone = document.getElementById("phone").value;
      if (!phone) return alert("Enter phone number first");

      latestBooking = {
        from: document.getElementById("from").value,
        to: document.getElementById("to").value,
        time: document.getElementById("time").value,
        luggage: document.getElementById("luggage").value,
        distance: document.getElementById("distance").value,
        duration: document.getElementById("duration").value,
        fare: document.getElementById("fare").value,
        phone
      };

      localStorage.setItem("booking", JSON.stringify(latestBooking));
      document.getElementById("message").innerText = "Booking Confirmed!";
    }

    function cancelBooking() {
      localStorage.removeItem("booking");
      latestBooking = null;
      document.getElementById("message").innerText = "Booking Cancelled.";
    }

    function sendBooking() {
      const booking = latestBooking || JSON.parse(localStorage.getItem("booking") || "null");
      if (!booking) {
        document.getElementById("message").innerText = "No booking to send.";
        return;
      }

      fetch("https://script.google.com/macros/s/AKfycbxy3eUjHDcOCr-cEpihTTrTnixw_6rE2B_w_25UxK2SnTXPYvT0f44jM3Ud1A2yEXKB_A/exec", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(booking)
      })
      .then(res => res.text())
      .then(() => {
        document.getElementById("message").innerText = "Request sent successfully!";
      })
      .catch(() => {
        document.getElementById("message").innerText = "Failed to send request.";
      });
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRdnvGw7epuDJjgBnpv0-FEuSQ6J-fyNY&libraries=places&callback=initMap">
  </script>
</body>
</html>
